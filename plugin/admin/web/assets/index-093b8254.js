import{f as r,d as O,k as N,s as K,e as W,U as $,V as j,$ as i,u as t,E as z,F as J}from"./vue-14860272.js";import{u as R,o as Y}from"./formily-de1f5b97.js";import{J as b,aw as g,ax as y,af as Q,R as X,ai as Z,ag as ee,a9 as te,aj as re}from"./index-6940427b.js";import{u as oe}from"./index-79686afe.js";import"./dayjs-4778c158.js";import{_ as se}from"./scroll-tip.vue_vue_type_script_setup_true_lang-06a0e4f7.js";import{u as ae}from"./useModal-231cd172.js";import{u as ne}from"./device-1dc5bed1.js";import{C as w}from"./Card-8c66b56c.js";import{a as le,T as h}from"./useFlexGapSupport-d0720122.js";import{S as ie}from"./index-3a962de2.js";import"./index-8bf1b192.js";import"./LeftOutlined-5bd8a798.js";import"./isNumeric-3f69e2aa.js";import"./index-9788fdab.js";import"./index-5174f10d.js";import"./index-00d65388.js";import"./index-14bb9a5e.js";import"./Group-70d09d1e.js";import"./index-2c49b025.js";import"./index-3d8f6fc8.js";import"./index-5ffcd845.js";import"./scrollTo-c1f6ee63.js";import"./mockjs-890b569b.js";import"./gb28281-bee701fe.js";const pe=(e,s)=>({type:"object",properties:{layout:{type:"void","x-component":"FormLayout","x-component-props":{layout:"inline"},properties:{Name:{type:"string","x-decorator":"FormItem","x-decorator-props":{style:"margin-right: 10px;width: 260px"},"x-component":"Input","x-component-props":{placeholder:"请输入流标识或源地址搜索","@keyup":e},"x-content":{prefix:()=>r(b,{icon:"ic:outline-search"},null)}},add:{type:"void","x-component":"Button","x-component-props":{"@click":()=>s()},"x-content":{default:"添加拉流转发",icon:()=>r(b,{icon:"ant-design:plus-outlined",class:"v-text-bottom mr-4px"},null)}}}}}}),ue=()=>({type:"object",properties:{layout:{type:"void","x-component":"FormLayout","x-component-props":{layout:"horizontal",labelCol:6,wrapperCol:14},properties:{streamPath:{type:"string",title:"流标识",description:"拉流进入m7s后的流地址","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:"请输入 m7s 流标识，如：live/test",allowClear:!0},required:!0},target:{type:"string",title:"源地址",description:"远端的http-flv、rtmp、rtsp或m3u8的地址","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:"请输入源地址",allowClear:!0},required:!0},type:{type:"boolean",title:"拉流协议",description:"无法根据源地址识别拉流协议，需要您确认","x-decorator":"FormItem","x-component":"Radio.Group",enum:[{label:"hdl",value:"hdl"},{label:"hls",value:"hls"}],"x-hidden":!0,required:!0},save:{type:"boolean",title:"拉流方式",enum:[{label:"临时拉流",value:0},{label:"启动拉流",value:1},{label:"按需拉流",value:2}],default:0,"x-decorator":"FormItem","x-component":"Radio.Group"}}}}}),F=g({requestOptions:{apiUrl:()=>y("hdl")}});function P(e){return F.get({url:"/pull",params:e},{errorMessageMode:"message"})}function L(){return F.get({url:"/list"},{errorMessageMode:"message"})}const C=g({requestOptions:{apiUrl:()=>y("rtmp")}});function me(e){return C.get({url:"/pull",params:e},{errorMessageMode:"message"})}function ce(){return C.get({url:"/list"},{errorMessageMode:"message"})}const V=g({requestOptions:{apiUrl:()=>y("rtsp")}});function de(e){return V.get({url:"/pull",params:e},{errorMessageMode:"message"})}function fe(){return V.get({url:"/list"},{errorMessageMode:"message"})}const D=g({requestOptions:{apiUrl:()=>y("hls")}});function he(e){return D.get({url:"/pull",params:e},{errorMessageMode:"message"})}function ge(){return D.get({url:"/list"},{errorMessageMode:"message"})}const{FormilyForm:ye,form:v,submit:xe}=R({schema:ue(),formProps:{initialValues:{streamPath:`live/test${new Date().getTime()}`},effects(){Y("target",e=>{if(!e.value){v.setFieldState("type",a=>{a.hidden=!0});return}const s=I(e.value);v.setFieldState("type",a=>{a.hidden=s!=="none"})})}}}),_e=e=>{switch(e){case"hdl":return P;case"rtmp":return me;case"rtsp":return de;case"hls":return he;default:return P}},I=e=>e?e.startsWith("rtmp://")?"rtmp":e.startsWith("rtsp://")?"rtsp":e.endsWith(".flv")?"hdl":e.endsWith(".m3u8")?"hls":"none":"none",Ee=({updateList:e,pause:s,resume:a})=>{s(),ae({content:()=>r(ye,null,null),modalConfig:{title:"添加拉流转发",maskClosable:!1,width:700,onOk:async()=>{const{streamPath:c,target:n,type:x,save:p}=await xe(),u=I(n)==="none"?x:I(n);return c?(await _e(u)({streamPath:c,target:n,save:p}),Q.success("已启动拉流!"),e(),Promise.resolve(!0)):(a(),Promise.reject(!1))},onClose:()=>{v.reset(),a()}}})},ve=O({name:"StreamProxy"}),ze=O({...ve,setup(e){const s=N("hdl"),a=o=>{switch(o){case"hdl":return L;case"rtmp":return ce;case"rtsp":return fe;case"hls":return ge;default:return L}};K(()=>{d()});const c=ne(),n=W(()=>c.deviceList),{httpRefreshTime:x}=X({VITE_PORT:"3000",VITE_GLOB_APP_TITLE:"M7S_ADMIN",VITE_GLOB_APP_SHORT_NAME:"m7s_admin",VITE_USE_MOCK:"true",VITE_PUBLIC_PATH:"/admin",VITE_DROP_CONSOLE:"true",VITE_BUILD_COMPRESS:"none",VITE_BUILD_COMPRESS_DELETE_ORIGIN_FILE:"false",VITE_GLOB_HTTP_REFRESH_TIME:"5000",VITE_USE_IMAGEMIN:"true",VITE_LEGACY:"false",VITE_M7S_SERVER:"",BASE_URL:"/admin",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),{pause:p,resume:u}=Z(d,x),U=o=>{const l=String(o.target.value).trim().toLowerCase();if(l){const f=new RegExp(l,"gi"),M=["ID","Name"],G=n.value.filter(E=>M.some(m=>String(E[m]).toLowerCase().indexOf(l)>-1)).map(E=>{const m=Object.assign({},E);return M.forEach(T=>{m[T]=String(m[T]).replace(f,H=>`<span style="color: #ff99a0">${H}</span>`)}),m});_(G),p()}else _(n.value),u()},B=()=>{Ee({updateList:d,pause:p,resume:u})},{FormilyForm:k}=R({schema:pe(U,B)}),A={toggleRowExpand:({expanded:o})=>{o?p():u()}},S=oe(),_=o=>{S.tableRef.reloadData(o||[])};function d(){return a(s.value)().then(o=>{_(o)}).catch(o=>{console.error(`stream-proxy-getList-error: ${o}`)})}d();const q={maxHeight:"100%",rowConfig:{keyField:"ID",useKey:!0},columnConfig:{useKey:!0},columns:[{field:"StreamPath",title:"流标识",showOverflow:"tooltip",width:"200px",fixed:"left",type:"html"},{field:"URL",title:"源地址",showOverflow:"tooltip",width:"120px",type:"html"},{field:"StartTime",title:"开始时间",minWidth:"180px",formatter:({cellValue:o})=>re.toDateString(new Date(o),"yyyy-MM-dd HH:ss:mm")},{field:"operate",title:"操作",width:"120px",fixed:"right",align:"center",slots:{default:"operate"}}],data:[]};return(o,l)=>($(),j(J,null,[r(t(w),{bordered:!1,bodyStyle:{padding:"26px 10px 0 10px",marginBottom:"8px"}},{default:i(()=>[r(t(k))]),_:1}),r(t(w),{bordered:!1,bodyStyle:{padding:"10px",height:"calc(100% - 50px)"},style:{height:"calc(100% - 100px)"}},{default:i(()=>[r(t(se),{windowWidth:1716}),r(t(le),{activeKey:s.value,"onUpdate:activeKey":l[0]||(l[0]=f=>s.value=f)},{default:i(()=>[r(t(h),{key:"hdl",tab:"hdl"}),r(t(h),{key:"rtmp",tab:"rtmp"}),r(t(h),{key:"rtsp",tab:"rtsp"}),r(t(h),{key:"hls",tab:"hls"})]),_:1},8,["activeKey"]),r(t(ee),{uid:t(S).uid,gridOptions:t(q),gridEvent:t(A)},{operate:i(({row:f})=>[r(t(ie),null,{default:i(()=>[r(t(te),{size:"small",type:"link"},{default:i(()=>[z(" 测试 ")]),_:1})]),_:1})]),_:1},8,["uid","gridOptions","gridEvent"])]),_:1},8,["bodyStyle"])],64))}});export{ze as default};
